- name: OpenScanHub
  hosts: os_control[0]:os_control_stg[0]
  user: root
  gather_facts: False

  vars_files:
    - /srv/web/infra/ansible/vars/global.yml
    - /srv/private/ansible/vars.yml
    - /srv/web/infra/ansible/vars/{{ ansible_distribution }}.yml

  vars:
    - ocp4: true

  pre_tasks:
  - include_vars: dir=/srv/web/infra/ansible/vars/all/ ignore_files=README

  roles:
  - role: openshift/project
    app: openscanhub
    description: openscanhub
    appowners:
    - svashisht
    - kevin
    - zlopez
    tags:
      - apply-appowners
    when: env == "production"
  - role: openshift/project
    app: openscanhub
    description: openscanhub
    appowners:
    - svashisht
    - kevin
    - zlopez
    tags:
      - apply-appowners
    when: env == "staging"
  - role: openshift/object
    app: openscanhub
    template: openscanhub-pvc-var-lib-osh.yml
    objectname: openscanhub-pvc-var-lib-osh
  - role: openshift/object
    app: openscanhub
    template: settings-local-configmap.yml
    objectname: settings-local-configmap
  - role: openshift/object
    app: openscanhub
    template: osh-hub-httpd-configmap.yml
    objectname: osh-hub-httpd-configmap
  - role: openshift/keytab
    app: openscanhub
    key: service.keytab
    secret_name: openscanhub-keytab
    service: HTTP
    # https://pagure.io/fedora-infra/ansible/pull-request/1669#comment-195794
    # We should get separate approval for "opencanhub.fedoraproject.org"
    # Fix below line if correct route is not generated.
    # https://pagure.io/fedora-infra/ansible/pull-request/1669#comment-195809
    host: "openscanhub.stg.fedoraproject.org"
    when: env == "staging"
  - role: openshift/object
    app: openscanhub
    file: openscanhub-deployment-fedora-osh-hub.yml
    objectname: openscanhub-deployment-fedora-osh-hub
    when: env == "staging"
  - role: openshift/object
    app: openscanhub
    file: openscanhub-route-fedora-osh-hub.yml
    objectname: openscanhub-route-fedora-osh-hub
    when: env == "staging"
  - role: openshift/object
    app: openscanhub
    file: openscanhub-service-fedora-osh-hub.yml
    objectname: openscanhub-service-fedora-osh-hub
    when: env == "staging"

  # Configurations for redis.
  - role: openshift/object
    app: openscanhub
    file: deployment-redis-6-c9s.yml
    objectname: deployment-redis-6-c9s
    when: env == "staging"
  - role: openshift/object
    app: openscanhub
    file: route-redis-6-c9s.yml
    objectname: route-redis-6-c9s
    when: env == "staging"
  - role: openshift/object
    app: openscanhub
    file: service-redis-6-c9s.yml
    objectname: service-redis-6-c9s
    when: env == "staging"

  # Configurations for resalloc-server.
  - role: openshift/object
    app: openscanhub
    template: etc-resallocserver-server-configmap.yml
    objectname: etc-resallocserver-server-configmap
    when: env == "staging"
  - role: openshift/object
    app: openscanhub
    template: etc-resallocserver-pools-configmap.yml
    objectname: etc-resallocserver-pools-configmap
    when: env == "staging"
  - role: openshift/object
    app: openscanhub
    template: aws-credentials-configmap.yml
    objectname: aws-credentials-configmap
    when: env == "staging"
  - role: openshift/object
    app: openscanhub
    template: aws-openscanhub-key.yml
    objectname: aws-openscanhub-key
    when: env == "staging"
  - role: openshift/object
    app: openscanhub
    file: deployment-resalloc-server.yml
    objectname: deployment-resalloc-server
    when: env == "staging"
  - role: openshift/object
    app: openscanhub
    file: route-resalloc-server.yml
    objectname: route-resalloc-server
    when: env == "staging"
  - role: openshift/object
    app: openscanhub
    file: service-resalloc-server.yml
    objectname: service-resalloc-server
    when: env == "staging"

    # sudo rbac-playbook -l staging -t delete openshift-apps/openscanhub.yml
  - role: openshift/object-delete
    app: openscanhub
    objecttype: project
    objectname: openscanhub
    tags: [never, delete]
    when: env == "staging"
