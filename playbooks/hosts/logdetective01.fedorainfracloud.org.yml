- name: check/create instance
  hosts: logdetective
  user: root
  gather_facts: False

  vars_files:
   - /srv/web/infra/ansible/vars/global.yml
   - /srv/private/ansible/vars.yml

  handlers:
  - import_tasks: "{{ handlers_path }}/restart_services.yml"

  tasks:
  - import_tasks: "{{ tasks_path }}/aws_cloud.yml"
    when: datacenter == 'aws'

  - import_tasks: "{{ tasks_path }}/swap.yml"
    when:
      - datacenter == 'aws'
      - swap_file_size_mb is defined

- name: cloud basic setup
  hosts: logdetective
  become: True
  become_user: root
  gather_facts: True
  vars_files:
   - /srv/web/infra/ansible/vars/global.yml
   - /srv/private/ansible/vars.yml

  pre_tasks:
  - import_tasks: "{{ tasks_path }}/yumrepos.yml"


  tasks:
  - import_tasks: "{{ tasks_path }}/cloud_setup_basic.yml"
  - name: Install basic packages
    ansible.builtin.dnf:
      name:
        - python3-pip
        - python3-devel
        - pciutils
        - git
        - podman
        - podman-compose
        - wget
        - gcc-c++

  - name: Download and install cuda drivers repo
    ansible.builtin.dnf:
      name: https://developer.download.nvidia.com/compute/cuda/12.5.1/local_installers/cuda-repo-fedora39-12-5-local-12.5.1_555.42.06-1.x86_64.rpm

  - name: Install cuda drivers
    ansible.builtin.dnf:
      name:
        - cuda-toolkit-12-5
        - nvidia-driver:open-dkms
    register: cuda_installation

  - name: Restart the system
    ansible.builtin.reboot:
    when: cuda_installation.changed

# this should be set to ansible_hostname
#  - name: "set hostname (required by some services, at least postfix need it)"
#    hostname: name="{{copr_hostbase}}.cloud.fedoraproject.org"
#    when: env != 'production'

- name: provision instance
  hosts: logdetective
  become: True
  become_user: root
  gather_facts: True

  vars_files:
   - /srv/web/infra/ansible/vars/global.yml
   - /srv/private/ansible/vars.yml
   - /srv/web/infra/ansible/vars/{{ ansible_distribution }}.yml

  # Roles are run first, before tasks, regardless of where you place them here.
  roles:
  - base
  - nagios_client
