- name: setup all the things
  hosts: iddev.fedorainfracloud.org
  gather_facts: True
  vars_files:
   - /srv/web/infra/ansible/vars/global.yml
   - /srv/private/ansible/vars.yml
   - /srv/private/ansible/files/openstack/passwords.yml
   - /srv/web/infra/ansible/vars/{{ ansible_distribution }}.yml

  roles:
  - basessh
  - sudo
  - hosts
  - mod_wsgi
  - base

  pre_tasks:
  - import_tasks: "{{ tasks_path }}/yumrepos.yml"

  tasks:
  - import_tasks: "{{ tasks_path }}/cloud_setup_basic.yml"
  - name: set hostname (required by some services, at least postfix need it)
    hostname: name="{{inventory_hostname}}"
  - name: Add an apache config to proxy letsencrypt
    shell: |
      echo '<VirtualHost *:80>
        ServerName iddev.fedorainfracloud.org
        ProxyPass "/.well-known/acme-challenge" "http://certgetter01/.well-known/acme-challenge"
        Redirect permanent / https://iddev.fedorainfracloud.org
     </VirtualHost>' > /etc/httpd/conf.d/proxy_letsencrypt.conf
  - name: reload apache
    ansible.builtin.service:
      name: httpd
      state: reloaded
  - name: Letsencrypt for iddev.fedorainfracloud.org
    include_role: name=letsencrypt
    vars:
      site_name: iddev.fedorainfracloud.org
    tags:
    - letsencrypt

  handlers:
  - import_tasks: "{{ handlers_path }}/restart_services.yml"
