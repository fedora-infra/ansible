SSLProxyEngine On

<Proxy "balancer://{{balancer_name}}-websocket">
  {% for member in balancer_members %}
    {% if http_not_https_yes_this_is_insecure_and_i_feel_bad %}
    {% if remotepath is defined and remotepath != "/" %}
    BalancerMember "ws://{{ member }}{{ remotepath }}"
    {% else %}
    BalancerMember "ws://{{ member }}"
    {% endif %}
    {% else %}
    {% if remotepath is defined and remotepath != "/" %}
    BalancerMember "wss://{{ member }}{{ remotepath }}"
    {% else %}
    BalancerMember "wss://{{ member }}"
    {% endif %}
    {% endif %}
  {% endfor %}
</Proxy>

RewriteEngine on
RewriteCond %{HTTP:Upgrade} ^WebSocket$ [NC]
RewriteCond %{HTTP:Connection} Upgrade [NC]
{% if remotepath is defined and remotepath != "/" %}
RewriteCond %{REQUEST_URI} ^{{ remotepath }}/(.)*
{% endif %}
RewriteRule .* "balancer://{{ balancer_name }}-websocket%{REQUEST_URI}" [P]

<Proxy "balancer://{{balancer_name}}">
  {% for member in balancer_members %}
    {% if http_not_https_yes_this_is_insecure_and_i_feel_bad %}
    BalancerMember "http://{{ member }}"
    {% else %}
    BalancerMember "https://{{ member }}"
    {% endif %}
  {% endfor %}
</Proxy>
{% if datacenter == 'iad2' %}
ProxyPass {{ localpath }} "balancer://{{balancer_name}}{{remotepath}}"
ProxyPassReverse {{ localpath }} "balancer://{{balancer_name}}{{remotepath}}"
{% else %}
Redirect 421 /
{% endif %}

