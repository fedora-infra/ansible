# Expected vars
# - website...
# - localpath..
# - remotepath..
# - proxyurl
# - rewrite
# - keephost
# - proxyopts

- name: Set OpenShift information if not preconfigured (prod)
  set_fact:
    balancer_members: "{{ openshift_nodes }}"
  when: 'targettype == "openshift" and balancer_members is not defined and env != "staging" '
  tags:
  - httpd
  - httpd/reverseproxy
  - httpd/reversepassproxy

- name: Set OpenShift4 information if not preconfigured (prod)
  set_fact:
    balancer_members: "{{ ocp_nodes }}"
  when: 'targettype == "openshift" and ocp4|bool and balancer_members is not defined and env != "staging" '
  tags:
  - httpd
  - httpd/reverseproxy
  - httpd/reversepassproxy

- name: Set OpenShift information if not preconfigured (stg)
  set_fact:
    balancer_members: "{{ openshift_nodes_stg }}"
  when: 'targettype == "openshift" and balancer_members is not defined and env == "staging" '
  tags:
  - httpd
  - httpd/reverseproxy
  - httpd/reversepassproxy

- name: Set OpenShift4 information if not preconfigured (stg)
  set_fact:
    balancer_members: "{{ ocp_nodes_stg }}"
  when: 'targettype == "openshift" and ocp4|bool and balancer_members is not defined and env == "staging" '
  tags:
  - httpd
  - httpd/reverseproxy
  - httpd/reversepassproxy

- name: Copy in ProxyPassReverse for {{destname}} ({{website}}{{remotepath}})
  template: >
    src={{item}}
    dest=/etc/httpd/conf.d/{{website}}/{{destname}}.conf
    owner=root
    group=root
    mode=0644
  with_first_found:
  - "{{  roles_path  }}/httpd/reverseproxy/templates/reversepassproxy.{{destname}}.conf"
  - "{{  roles_path  }}/httpd/reverseproxy/templates/reversepassproxy.conf"
  notify:
  - reload proxyhttpd
  tags:
  - httpd
  - httpd/reverseproxy
  - httpd/reversepassproxy

- name: clear balancer_members
  set_fact:
    balancer_members: !!null
