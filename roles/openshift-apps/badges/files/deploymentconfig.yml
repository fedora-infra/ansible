---
# Frontend component (Python/Pyramid served by gunicorn)
apiVersion: apps.openshift.io/v1
kind: DeploymentConfig
metadata:
  name: frontend
  labels:
    app: badges
spec:
  replicas: 1
  selector:
    app: badges
    deploymentconfig: frontend
  strategy:
    type: Rolling
    activeDeadlineSeconds: 21600
    rollingParams:
      intervalSeconds: 1
      maxSurge: 25%
      maxUnavailable: 25%
      timeoutSeconds: 600
      updatePeriodSeconds: 1
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: badges
        deploymentconfig: frontend
    spec:
      containers:
        - name: frontend
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: etc-badges
              mountPath: "/etc/badges"
              readOnly: true
            - name: ipa-config-volume
              mountPath: /etc/ipa
              readOnly: true
            - name: keytab-volume
              mountPath: /etc/keytabs
              readOnly: true
            - name: fedora-messaging-ca-volume
              mountPath: /etc/pki/fedora-messaging/ca
              readOnly: true
            - name: fedora-messaging-key-volume
              mountPath: /etc/pki/fedora-messaging/key
              readOnly: true
            - name: fedora-messaging-crt-volume
              mountPath: /etc/pki/fedora-messaging/crt
              readOnly: true

          env:
            - name: APP_MODULE
              value: "deploy.wsgi"
            - name: APP_CONFIG
              value: "/etc/noggin/gunicorn.conf.py"
            - name: OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: badges
                  key: oidc-client-secret
            - name: KRB5_CONFIG
              value: /etc/ipa/krb5.conf
            - name: KRB5_CLIENT_KTNAME
              value: /etc/keytabs/service.keytab
            - name: FEDORA_MESSAGING_CONF
              value: /etc/badges/fm-tahrir.toml

          # readinessProbe:
          #   timeoutSeconds: 1
          #   initialDelaySeconds: 5
          #   httpGet:
          #     path: /api/v1/healthz/ready
          #     port: 8080
          # livenessProbe:
          #   timeoutSeconds: 1
          #   initialDelaySeconds: 20
          #   httpGet:
          #     path: /api/v1/healthz/live
          #     port: 8080

      volumes:
        - name: etc-badges
          configMap:
            name: badges
        - name: ipa-config-volume
          configMap:
            name: ipa-client-config
        - name: keytab-volume
          secret:
            secretName: keytab
        - name: fedora-messaging-ca-volume
          secret:
            secretName: fedora-messaging-ca
        - name: fedora-messaging-key-volume
          secret:
            secretName: fedora-messaging-key
        - name: fedora-messaging-crt-volume
          secret:
            secretName: fedora-messaging-crt
  triggers:
    - type: ConfigChange
    - type: ImageChange
      imageChangeParams:
        automatic: true
        containerNames:
          - frontend
        from:
          kind: ImageStreamTag
          name: tahrir:latest
---
# Consumer component (Fedora Messaging consume command)
apiVersion: apps.openshift.io/v1
kind: DeploymentConfig
metadata:
  name: consumer
  labels:
    app: badges
spec:
  # There can be as many as necessary
  replicas: 1
  selector:
    app: badges
    deploymentconfig: consumer
  strategy:
    type: Recreate
    # recreateParams:
    #   mid:
    #     execNewPod:
    #       command: [/opt/app-root/bin/fmn, database, sync]
    #       containerName: consumer
    #       volumes:
    #         - etc-badges
    #     failurePolicy: Abort
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: badges
        deploymentconfig: consumer
    spec:
      containers:
        - name: consumer
          imagePullPolicy: Always
          volumeMounts:
            - name: etc-badges
              mountPath: "/etc/badges"
              readOnly: true
            - name: ipa-config-volume
              mountPath: /etc/ipa
              readOnly: true
            - name: keytab-volume
              mountPath: /etc/keytabs
              readOnly: true
            - name: fedora-messaging-ca-volume
              mountPath: /etc/pki/fedora-messaging/ca
              readOnly: true
            - name: fedora-messaging-key-volume
              mountPath: /etc/pki/fedora-messaging/key
              readOnly: true
            - name: fedora-messaging-crt-volume
              mountPath: /etc/pki/fedora-messaging/crt
              readOnly: true
          env:
            - name: KRB5_CONFIG
              value: /etc/ipa/krb5.conf
            - name: KRB5_CLIENT_KTNAME
              value: /etc/keytabs/service.keytab
      volumes:
        - name: etc-badges
          configMap:
            name: badges
        - name: ipa-config-volume
          configMap:
            name: ipa-client-config
        - name: keytab-volume
          secret:
            secretName: keytab
        - name: fedora-messaging-ca-volume
          secret:
            secretName: fedora-messaging-ca
        - name: fedora-messaging-key-volume
          secret:
            secretName: fedora-messaging-key
        - name: fedora-messaging-crt-volume
          secret:
            secretName: fedora-messaging-crt
  triggers:
    - type: ConfigChange
    - type: ImageChange
      imageChangeParams:
        automatic: true
        containerNames:
          - consumer
        from:
          kind: ImageStreamTag
          name: fedbadges:latest
