---
apiVersion: v1
kind: DeploymentConfig
metadata:
  name: debuginfod
  labels:
    app: debuginfod
spec:
  replicas: 1
  selector:
    app: debuginfod
    deploymentconfig: debuginfod
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: debuginfod
        deploymentconfig: debuginfod
    spec:
      selector:
        app: debuginfod
        deploymentconfig: debuginfod
      containers:
      - name: debuginfod
        image: debuginfod:latest
        command: ["/usr/bin/debuginfod",
                  "-vvv",
                  "-d", "/var/cache/debuginfod/db.sqlite",
                  "-c", "8",
                  "-t", "3600",
                  "-g", "604800",
                  # exclude signed etc. variants, just want original RPMs
                  "-X", "/data/",
                  "-R", "/mnt/koji/packages",
                  "-I", "\\.fc(32|33|34|35)\\..*\\.rpm$"]
        ports:
        - containerPort: 8002
        resources:
          requests:
            memory: 24000Mi
            cpu: 8000m
        volumeMounts:
         - name: debuginfod-storage{{ '-stg' if env == 'staging' else '' }}
           mountPath: /var/cache/debuginfod
           readOnly: false
         - name: fedora-koji
           mountPath: /mnt
           readOnly: true
        readinessProbe:
          timeoutSeconds: 1
          initialDelaySeconds: 30
          httpGet:
            path: /metrics
            port: 8002
        livenessProbe:
          timeoutSeconds: 1
          initialDelaySeconds: 30
          periodSeconds: 30
          httpGet:
            path: /metrics
            port: 8002
      volumes:
      - name: debuginfod-storage{{ '-stg' if env == 'staging' else '' }}
        persistentVolumeClaim:
          claimName: debuginfod-storage{{ '-stg' if env == 'staging' else '' }}
      - name: fedora-koji
        persistentVolumeClaim:
          claimName: fedora-koji
  triggers:
  - type: ConfigChange
  - type: ImageChange
    imageChangeParams:
      automatic: true
      containerNames: ["debuginfod"]
      from:
        kind: ImageStreamTag
        name: debuginfod:latest

        
