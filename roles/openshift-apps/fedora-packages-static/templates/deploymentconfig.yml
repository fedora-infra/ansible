---
apiVersion: v1
kind: DeploymentConfig
metadata:
  labels:
    app: fedora-packages-static
    service: fedora-packages-static
  name: fedora-packages-static
spec:
  replicas: 1
  selector:
    app: fedora-packages-static
    deploymentconfig: fedora-packages-static
  strategy:
    type: Rolling
  template:
    metadata:
      labels:
        app: fedora-packages-static
        deploymentconfig: fedora-packages-static
    spec:
      initContainers:
      - name: init-solr
        image: busybox
        command: ['sh', '-c', 'until ping -c1 solr{{ env_suffix }}.fedoraproject.org >/dev/null 2>&1; do echo waiting for solr; sleep 2; done']
      containers:
      - name: fedora-packages-static
        image: fedora-packages-static:latest
        env:
        - name: SOLR_URL
          valueFrom:
            configMapKeyRef:
              name: fedora-packages-static-configmap
              key: solr-url
        - name: SITEMAP_URL
          valueFrom:
            configMapKeyRef:
              name: fedora-packages-static-configmap
              key: sitemap-url
        ports:
        - containerPort: 80
        resources: {}
        volumeMounts:
        - name: data-volume
          mountPath: /srv/packages
        - name: db-volume
          mountPath: /etc/packages
        readinessProbe:
          timeoutSeconds: 1
          # Needs time to do inital sync, which should take about five minutes
          initialDelaySeconds: 600
          httpGet:
            path: /
            port: 80
        livenessProbe:
          timeoutSeconds: 1
          initialDelaySeconds: 630
          httpGet:
            path: /
            port: 80
      volumes:
      - name: data-volume
        persistentVolumeClaim:
          claimName: fedora-packages-static-storage{{ '-stg' if env == 'staging' else '' }}
      - name: db-volume
        persistentVolumeClaim:
          claimName: fedora-packages-static-db-storage{{ '-stg' if env == 'staging' else '' }}

  triggers:
  - type: ConfigChange
  - type: ImageChange
    imageChangeParams:
      automatic: true
      containerNames:
      - fedora-packages-static
      from:
        kind: ImageStreamTag
        name: fedora-packages-static:latest
