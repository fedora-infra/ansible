---
# the magic with ! is that it return exit code 1 if 'already defined' is not present in output
- name: add repositories
  shell: ! faf repoadd --nogpgcheck "{{ item.name }}" dnf "{{ item.url | join('" "') }}" 2>&1 | grep 'already defined'
  become: yes
  become_user: faf
  ignore_errors: yes
  tags: add_repo
  loop: "{{ faf_repos }}"

- name: repoassign repositories
  command: faf repoassign "{{ item.name }}" "{{ item.opsys }}" "{{ item.arch }}"
  become: yes
  become_user: faf
  tags: add_repo
  loop: "{{ faf_repos }}"

- import_tasks: cron.yml
  tags: cron

- name: get repolist of EOL releases
  shell: "faf repolist | grep fedora-{{ item }} || true"
  become: yes
  become_user: faf
  register: eol_repolist
  loop: "{{ rs_internal_fedora_vers_removed }}"
  changed_when: eol_repolist.stdout

- name: remove repos of EOLed releases
  command: faf repodel "{{ item }}"
  become: yes
  become_user: faf
  ignore_errors: yes
  loop: "{{ eol_repolist.results | map(attribute='stdout_lines') | flatten }}"

- name: cleanup packages from EOLed fedora release
  command: "faf cleanup-packages Fedora '{{ item }}' "
  become: yes
  become_user: faf
  loop: "{{ rs_internal_fedora_vers_removed }}"
