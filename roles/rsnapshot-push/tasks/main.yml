---
- name: backup script
  template:
    src: client-backup-script.sh.j2
    dest: "/usr/local/bin/{{ item.value.command }}"
    owner: "{{ item.value.user }}"
    group: "{{ item.value.user }}"
    mode: 0700
  with_dict:
  - "{{ rsnapshot_push.cases }}"
  tags: rsnapshot_push

- name: server-side case-specific backup dir
  file:
    path: "{{ '/'.join([rsnapshot_push.backup_dir, item.key]) }}"
    state: directory
    owner: "{{ item.value.user }}"
    group: "{{ item.value.user }}"
    mode: 0700
  with_dict:
    - "{{ rsnapshot_push.cases }}"
  delegate_to: "{{ rsnapshot_push.server_host }}"
  tags: rsnapshot_push

- name: server-side custom rsnapshot daemon script
  template:
    src: server-daemon.sh.j2
    dest: "{{ '/'.join([rsnapshot_push.backup_dir, item.key, 'sync-daemon']) }}"
    owner: "{{ item.value.user }}"
    group: "{{ item.value.user }}"
    mode: 0700
  with_dict:
  - "{{ rsnapshot_push.cases }}"
  delegate_to: "{{ rsnapshot_push.server_host }}"
  tags: rsnapshot_push

- name: rsnapshot call wrapper
  template:
    src: server-rsnapshot.py.j2
    dest: "{{ '/'.join([rsnapshot_push.backup_dir, item.key, 'rsnapshot']) }}"
    owner: "{{ item.value.user }}"
    group: "{{ item.value.user }}"
    mode: 0700
  with_dict:
  - "{{ rsnapshot_push.cases }}"
  delegate_to: "{{ rsnapshot_push.server_host }}"
  tags: rsnapshot_push

- name: backup praiskup data
  cron: name="backup documents - {{ item.key }}"
        minute="0/5"
        hour="*"
        user={{ item.value.user }}
        job=/usr/local/bin/"{{ item.value.command }}"
  with_dict:
  - "{{ rsnapshot_push.cases }}"
  tags: rsnapshot_push
