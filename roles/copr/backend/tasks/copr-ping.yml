---
- set_fact:
    ping_user: copr-ping
    ping_scriptdir: /home/copr-ping
    ping_log: /var/log/copr-ping.log
    ping_script: copr-ping-script.sh
    ping_check: copr-ping-check.py
  tags: copr_ping

- stat: path={{ ping_log }}
  register: ping_log
  tags: copr_ping

- name: pre-create ping log file
  file:
    path: "{{ ping_log }}"
    owner: "{{ ping_user }}"
    group: nagios
    mode: '0644'
  when: not ping_log.stat.exists
  tags: copr_ping

- name: create the user ping user
  user: name={{ ping_user }}
  tags: copr_ping

- name: install copr-cli package
  dnf: name=copr-cli state=latest
  tags: copr_ping

- name: install the ping script
  template:
    dest: "{{ ping_scriptdir }}/{{ ping_script }}"
    src: "{{ ping_script }}.j2"
    owner: "{{ ping_user }}"
    group: "{{ ping_user }}"
    mode: 0700
  tags: copr_ping

- name: install the check script
  template:
    dest: "/usr/bin/{{ ping_check }}"
    src: "{{ ping_check }}.j2"
    owner: "{{ ping_user }}"
    group: "{{ ping_user }}"
    mode: 0700
  tags: copr_ping

- name: rebuild the copr-ping package periodically
  ansible.builtin.cron:
    name: build the ping package
    minute: "{% if devel %}0{% else %}0,30{% endif %}"
    hour: "{% if devel %}1{% else %}*{% endif %}"
    user: copr-ping
    job: "{{ ping_scriptdir }}/{{ ping_script }}"
  tags: copr_ping
