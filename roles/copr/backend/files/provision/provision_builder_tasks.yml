---
- name: remove the hackish package breaking s390x subscriptions
  shell:
    cmd: rpm -evh `rpm -qa | grep katello-` ; subscription-manager clean
  when:
    - prepare_base_image is not defined
    - "'s390x' in lookup('env', 'RESALLOC_NAME')"

- name: setup the hostname so we can easily identify the box
  hostname: name="{{ lookup('env', 'RESALLOC_NAME') | default('unknown-builder') | replace('_', '-') }}"
  when: prepare_base_image is not defined

- name: put infra repos into yum.repos.d
  copy: src=files/dnf/infra-tags.repo dest=/etc/yum.repos.d
  when:
  - prepare_base_image is defined

- name: put infra stg repos into yum.repos.d if staging
  copy: src=files/dnf/infra-tags-stg.repo dest=/etc/yum.repos.d
  when:
    - devel
    - not prepare_base_image is defined

- name: disable updates-testing
  file:
    path: /etc/yum.repos.d/fedora-updates-testing.repo
    state: absent

- name: update the system
  dnf:
    state: latest
    name: "*"
    exclude:
      - kernel-core  # https://bugzilla.redhat.com/show_bug.cgi?id=2013183
  when: prepare_base_image is defined
  register: system_updated

- name: disable updates-testing, could be restored after update
  file:
    path: /etc/yum.repos.d/fedora-updates-testing.repo
    state: absent
  when: system_updated.changed

 #- name: enable copr repo in staging
 #  community.general.copr:
 #    state: enabled
 #    name: "{{ item }}"
 #  with_items:
 #    - "@copr/copr"
 #  when:
 #    - devel
 #    - prepare_base_image is not defined

- name: clean dnf cache
  shell: dnf clean all
  when:
    - prepare_base_image is defined

- name: set lower metadata expire time to enforce download
  ini_file: dest=/etc/dnf/dnf.conf section=main option=metadata_expire value=1h
  when:
    - prepare_base_image is defined

# https://fedoraproject.org/wiki/Changes/StrongCryptoSettings
- name: fallback to the legacy crypto policies
  command: update-crypto-policies --set DEFAULT:FEDORA32
  when:
    - prepare_base_image is defined

# NetworkManager-wait-online takes too long on VMS on our hypervisors.  And we
# don't seem to need hcn-init service triggering that.
- name: disable hcn-init service on ppc64le which implies NetworkManager-wait-online
  service:
    name: hcn-init.service
    state: stopped
    enabled: no
  failed_when: false
  when: prepare_base_image is defined

- package_facts: manager=auto

- name: install subscription-manager
  package: name=subscription-manager state=present
  # TODO: we should use 'when: prepare_base_image is defined' instead, but a new
  # set of builder images needs to be generated first so the image contains the
  # subscription-manager by default.
  when: "'subscription-manager' not in ansible_facts.packages"

- name: Activate Red Hat Subscription
  community.general.redhat_subscription:
    state: present
    username: copr-team
    force_register: true
    password: "{{ copr_red_hat_subscription_password }}"
    consumer_name: "{{ lookup('env', 'RESALLOC_NAME') | default('unknown-builder') }}"
    server_hostname: subscription.rhsm.redhat.com
    pool_ids:
      - "8a85f9a17c71102f017ce611251c770f"
  when:
    - prepare_base_image is not defined
    - copr_red_hat_subscription_password is defined
  tags:
    - red_hat_subscription
  ignore_errors: true
  register: subscription

- name: Cleanup subscription before failure
  shell: subscription-manager unregister
  when: subscription.failed

- fail: msg="Could not subscribe"
  when: subscription.failed

- name: install copr-builder and other latest packages
  dnf: state=latest pkg={{ packages }}
  vars:
    packages:
    - copr-builder

- name: stat /etc/copr-rpmbuild/mock.cfg.j2.rpmnew
  stat: path=/etc/copr-rpmbuild/mock.cfg.j2.rpmnew
  register: mock_cfg_new

- name: restore mock.cfg.j2 from package contents
  shell: mv -f /etc/copr-rpmbuild/mock.cfg.j2.rpmnew /etc/copr-rpmbuild/mock.cfg.j2
  when: mock_cfg_new.stat.exists

- name: put updated mock configs into /etc/mock
  copy: src=files/mock/ dest=/etc/copr-rpmbuild/mock-config-overrides
  # conditional, per https://pagure.io/copr/copr/issue/1189 - as we don't want
  # to bake broken mock configuration into the image.
  when:
  - prepare_base_image is not defined

- name: don't remove rpmnew files, but always use them
  lineinfile: state=absent regexp='^find /etc/mock.*-delete'
              path=/usr/bin/copr-update-builder

- name: run /bin/copr-update-builder from copr-builder package
  shell: /usr/bin/copr-update-builder

#- name: install the latest mock and mock-core-configs from updates-testing
#  package: state=latest name={{ packages }}
#  register: mock_updated
#  vars:
#    packages:
#    - https://kojipkgs.fedoraproject.org/packages/mock/2.2/1.fc31/noarch/mock-2.2-1.fc31.noarch.rpm
#    - https://kojipkgs.fedoraproject.org/packages/mock-core-configs/32.6/1.fc31/noarch/mock-core-configs-32.6-1.fc31.noarch.rpm
#
# - name: re-run copr-update builder when mock/mock-core-configs are updated
#   shell: /usr/bin/copr-update-builder
#   when: mock_updated.changed

- name: "Link Mock EPEL 8 configs to rhel+epel-8"
  file:
    src: "/etc/mock/rhel+epel-8-{{ item }}.cfg"
    force: true
    path: "/etc/mock/epel-8-{{ item }}.cfg"
    state: link
  loop:
    - x86_64
    - aarch64
    - ppc64le
    - s390x
  tags:
  - provision_config

- name: put copr-rpmbuild configuration file in the right place
  copy: src=files/main.ini dest=/etc/copr-rpmbuild/main.ini

# This taks is to be dropped once we migrate to F35.  On F35, we want to keep
# the default /etc/rpkg.conf untouched!
- name: put rpkg configuration file to the right place
  copy: src=files/rpkg.conf dest=/etc/rpkg.conf
  when:
  - prepare_base_image is not defined

- name: mockbuilder user
  user: name=mockbuilder groups=mock

- name: mockbuilder .ssh
  file: state=directory path=/home/mockbuilder/.ssh mode=0700 owner=mockbuilder group=mockbuilder

- name: mockbuilder authorized_keys
  authorized_key: user=mockbuilder key='{{ lookup('file', 'files/buildsys.pub') }}'

- name: root authorized_keys
  authorized_key: user=root key='{{ lookup('file', 'files/buildsys.pub') }}'

- name: increase soft limit for opened file descriptors
  lineinfile: dest=/etc/security/limits.conf line="* soft nofile 10240" insertafter=EOF
  when:
    - prepare_base_image is defined

- name: increase hard limit for opened file descriptors
  lineinfile: dest=/etc/security/limits.conf line="* hard nofile 10240" insertafter=EOF
  when:
    - prepare_base_image is defined

- name: disable core dumps
  ini_file: dest=/etc/systemd/coredump.conf section=Coredump option=Storage value=none

- name: 'Remove %_install_langs from /etc/rpm/macros.image-language-conf'
  lineinfile:
    dest: '/etc/rpm/macros.image-language-conf'
    regexp: '^%_install_lang.*'
    state: 'absent'

- name: Disable DNF makecache timer
  systemd:
    name: dnf-makecache.timer
    state: stopped
    enabled: no

- name: Disable DNF makecache service
  systemd:
    name: dnf-makecache.service
    state: stopped
    enabled: no

- name: mount cache filesystem on /var/cache/mock
  mount: path=/var/cache/mock state=mounted src=mock_cache_tmpfs fstype=tmpfs opts="size=32G"

- name: Collect facts about builder hardware
  setup:
    gather_subset:
    - hardware

- name: Make sure that at least 135G of swap is available
  assert:
    that:
      - ansible_memory_mb.swap.free >= 1024 * 135
    fail_msg: "Swap is not available, the builder is unusable"
    success_msg: "Swap seems to be available for this builder"
  when:
  - prepare_base_image is not defined

# Make sure we have the latest version of the gem2rpm pacakge otherwise it may
# have problems fetching from rubygems.org and fail. This is a temporary
# workaround until we properly define the dependency on latest version in
# copr-rpmbuild package.
- name: Update gem2rpm package to the latest version
  dnf: state=latest pkg=rubygem-gem2rpm

# We want to drop this change with F35, too.
# See https://pagure.io/copr/copr/pull-request/1950
- name: copy temporary rpkg.conf.j2 until builders run F35
  copy: src=files/copr-rpmbuild/rpkg.conf.j2 dest=/etc/copr-rpmbuild/rpkg.conf.j2
  when:
  - prepare_base_image is not defined

- name: install the CentOS DistGit config file
  copy:
    src: files/copr-distgit-client/centos-stream.ini
    dest: /etc/copr-distgit-client/centos-stream.ini
    mode: 0644
  when:
  - prepare_base_image is not defined
