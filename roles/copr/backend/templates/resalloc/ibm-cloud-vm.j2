#! /bin/bash

case $RESALLOC_NAME in
    *tokyo*)
        vpc_id=r022-8438169e-d881-4bda-b603-d31fdf0f8b3a
        security_group_id=r022-bf49b90e-c00f-4c68-8707-2936b47b286b
        ssh_key_id=r022-3918e368-8e00-4e23-9119-5e3ce1eb33bd
        instance_type=cz2-2x4
        subnets_ids="jp-tok-1:02e7-84755ffa-97bb-4067-b618-24c788c901cb jp-tok-2:02f7-98674f68-aae1-4ea1-a889-5a0b7a07f4b8 jp-tok-3:02g7-6d92562d-b868-411f-a962-99271d609ba6"
        zone=jp-tok
        ;;
    *)
        echo "Can't decide what location to assign from: $RESALLOC_NAME"
        exit 1
        ;;
esac

params=()

if [ "$1" == "create" ]; then
    params+=(
        --playbook "{{ provision_directory }}/libvirt-provision.yml"
        --image-uuid "{{ copr_builder_images.ibm_cloud.s390x }}"
        --vpc-id "$vpc_id"
        --security-group-id "$security_group_id"
        --ssh-key-id "$ssh_key_id"
        --instance-type "$instance_type"
        --subnets-ids $subnets_ids
        --
    )
fi

exec resalloc-ibm-cloud-vm \
    --token-file "{{ ibmcloud_token_file }}" \
    --zone "$zone" \
    --log-level debug \
    "$1" \
    "${params[@]}" \
    "${@:2}"
