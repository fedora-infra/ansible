---
- name: enable swap in fstab
  mount: name=none src=LABEL=swap
         fstype=swap opts=sw passno=0 dump=0
         state=present
  register: fstab_swap_entry
  tags: swap

- name: mount the swap
  shell: swapon -a
  when: fstab_swap_entry.changed
  tags: swap

- set_fact: image_pool_dir=/libvirt-images
  tags: libvirt

- name: create libvirt image directory
  file: path={{ image_pool_dir }}
        owner=qemu group=qemu mode=0700
        state=directory
  tags: libvirt

- name: mount libvirt image partition
  mount: name={{ image_pool_dir }} src='LABEL=vmvolumes'
         fstype=ext4 state=mounted
  tags: libvirt

- name: correct selinux
  sefcontext:
    target: "{{ image_pool_dir }}(/.*)?"
    setype: virt_image_t
    state: present
  register: semanage_run
  tags: libvirt

- name: restorecon
  shell: restorecon -irv "{{ image_pool_dir }}"
  when: semanage_run.changed
  tags: libvirt

- name: create the copr user
  user: name=copr uid=11666

- name: assure that copr-be can ssh there as copr@...
  authorized_key: user=copr key="{{ item }}"
  with_file:
  - buildsys.pub

# todo: generate it's own key
- name: make sure hostA can ssh to hostB
  copy:
    src: "{{ private }}/files/copr/buildsys.priv"
    dest: /home/copr/.ssh/id_rsa
    owner: copr
    group: copr
    mode: 0600

- name: install libvirt packages
  package: name={{ item }} state=present
  with_items:
  - qemu-kvm
  - libvirt
  - virt-install

- name: install libvirtd.conf
  copy: src="{{ files }}/virthost/libvirtd.conf" dest=/etc/libvirt/libvirtd.conf
  notify:
  - restart libvirtd
  tags:
  - config

- name: add copr user to some virthosts that will run copr builders
  user: name=copr password_lock=true group=libvirt
