- name: install packages needed
  package: name={{ item }} state=present
  with_items:
  - squid
  - gettext
  - nss_wrapper
  - bind-utils
  tags:
  - flatpak-cache
  - config

- name: Ensure /var/spool/squid directory exists
  file:
    path: /var/spool/squid
    state: directory
    owner: squid
    group: squid
    mode: 0755
  tags:
  - flatpak-cache
  - config

- name: Ensure /etc/pki/squid directory exists
  file:
    path: /etc/pki/squid
    state: directory
    owner: squid
    group: squid
    mode: 0755
  tags:
  - flatpak-cache
  - config

- name: Ensure /var/lib/squid/ssl_db exists
  file:
    path: /var/lib/squid/ssl_db
    state: directory
    owner: squid
    group: squid
    mode: 0755
  tags:
  - flatpak-cache
  - config

- name: Install squid configuration file
  template: src=squid.conf dest=/etc/squid/squid.conf
  tags:
  - flatpak-cache
  - config

- name: Install SSL Certificates
  copy: src={{ item.src }}
      dest=/etc/pki/squid/{{ item.dest }}
      owner={{ item.owner }} group={{ item.group }} mode = {{ item.mode }}
  with_items:
  - src: "{{private}}/files/flatpak-cache-certs/production/pki/ca.crt"
    dest: ca.crt
    owner: squid
    group: squid
    mode: "644"
  - src: "{{private}}/files/flatpak-cache-certs/production/pki/private/ca.key"
    dest: ca.key
    owner: squid
    group: squid
    mode: "644"
  - src: "{{private}}/files/flatpak-cache-certs/production/pki/dh.pem"
    dest: dh.pem
    owner: squid
    group: squid
    mode: "644"

- name: Generate SSL Database
  command: /usr/lib64/squid/security_file_certgen -c -s /var/lib/squid/ssl_db
  tags:
  - flatpak-cache
  - config

- name: Enable and start squid service
  systemd_service:
    name: squid.service
    enabled: true
    state: started
  tags:
  - flatpak-cache
  - config
