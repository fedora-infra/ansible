- name: install packages needed
  package: name={{ item }} state=present
  with_items:
  - squid
  - gettext
  - nss_wrapper
  - bind-utils
  tags:
  - flatpak-cache
  - config

- name: Ensure /var/spool/squid directory exists
  file:
    path: /var/spool/squid
    state: directory
    owner: squid
    group: squid
    mode: 0755
  tags:
  - flatpak-cache
  - config

- name: Ensure /etc/pki/squid directory exists
  file:
    path: /etc/pki/squid
    state: directory
    owner: squid
    group: squid
    mode: 0755
  tags:
  - flatpak-cache
  - config

- name: Install squid configuration file
  template: src=squid.conf dest=/etc/squid/squid.conf
  tags:
  - flatpak-cache
  - config

- name: Install SSL Certificates
  copy:
    src: "{{ item }}"
    dest: /etc/pki/squid/
    owner: squid
    group: squid
    mode: 0644
  with_items:
  - "{{private}}/files/flatpak-cache-certs/production/pki/ca.crt"
  - "{{private}}/files/flatpak-cache-certs/production/pki/private/ca.key"
  - "{{private}}/files/flatpak-cache-certs/production/pki/dh.pem"
  tags:
  - flatpak-cache
  - config

- name: Check if /var/lib/squid/ssl_db/index.txt exists
  stat:
    path: /var/lib/squid/ssl_db/index.txt
  register: index_txt_stat
  tags:
  - flatpak-cache
  - config

- name: Generate SSL Database
  command: /usr/lib64/squid/security_file_certgen -c -s /var/lib/squid/ssl_db -M 4096
  when: not index_txt_stat.stat.exists
  tags:
  - flatpak-cache
  - config

- name: Enable and start squid service
  systemd_service:
    name: squid.service
    enabled: true
    state: started
  tags:
  - flatpak-cache
  - config
