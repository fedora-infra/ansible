---
- name: Install IPA client packages
  package:
    name:
      - freeipa-client
    state: present
  tags:
    - ipa/client
    - packages

- name: Clean up annoying remnants of previous FAS client installations
  import_tasks: cleanup.yml
  # don't muck with prod for now
  when: env == 'staging'
  tags:
    - ipa/client
    - fas-client-cleanup

- name: Enroll system as IPA client
  command:
    cmd: ipa-client-install
         --hostname={{ inventory_hostname }}
         --domain={{ ipa_realm | lower }}
         --realm={{ ipa_realm }}
         -p admin -w {{ ipa_admin_password }}
         -U -N --force-join
         --mkhomedir
    creates: /etc/ipa/default.conf
  tags:
    - ipa/client
    - config

- name: Prepare IPA-related information to make the following more efficient
  delegate_to: localhost
  import_tasks: prepare-ipa-info.yml
  tags:
    - ipa/client
    - config
  run_once: yes

- name: Basic configuration for clients on IPA cluster
  delegate_to: localhost
  import_tasks: common.yml
  # don't muck with prod for now
  when: env == 'staging'
  tags:
    - ipa/client
    - config
  run_once: yes

- name: Configure HBAC on IPA cluster
  delegate_to: "{{ ipa_server }}"
  import_tasks: hbac.yml
  # don't muck with prod for now
  when: env == 'staging'
  tags:
    - ipa/client
    - config
  run_once: yes

- name: Configure sudo on IPA cluster
  delegate_to: "{{ ipa_server }}"
  import_tasks: sudo.yml
  # don't muck with prod for now
  when: env == 'staging'
  tags:
    - ipa/client
    - config
  run_once: yes
