---
- name: Create host entry
  delegate_to: "{{ ipa_server }}"
  ipahost:
    ipaadmin_password: "{{ ipa_admin_password }}"
    name: "{{ host }}"
    force: yes
  tags:
  - config
  - krb5

- name: Check if service exists
  delegate_to: "{{ ipa_server }}"
  stat:
    path: "{{ service }}/{{ host }}"
  register: ipa_service_defined
  tags:
    - config
    - krb5

- name: Create service entry
  delegate_to: "{{ ipa_server }}"
  ipaservice:
    ipaadmin_password: "{{ ipa_admin_password }}"
    name: "{{ service }}/{{ host }}"
    principal: "{{ principal_alias | default(omit) }}"
    force: yes
  when: not ipa_service_defined.stat.exists
  tags:
  - config
  - krb5
